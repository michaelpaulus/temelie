{
  "triggerName": "iduSalesOrderDetail",
  "schemaName": "Sales",
  "definition": "CREATE TRIGGER [Sales].[iduSalesOrderDetail]\n    ON [Sales].[SalesOrderDetail]\n    AFTER INSERT, DELETE, UPDATE\n    AS BEGIN\n           DECLARE @Count AS INT;\n           SET @Count = @@ROWCOUNT;\n           IF @Count = 0\n               RETURN;\n           SET NOCOUNT ON;\n           BEGIN TRY\n               IF UPDATE ([ProductID]) OR UPDATE ([OrderQty]) OR UPDATE ([UnitPrice]) OR UPDATE ([UnitPriceDiscount])\n                   BEGIN\n                       INSERT INTO [Production].[TransactionHistory] ([ProductID], [ReferenceOrderID], [ReferenceOrderLineID], [TransactionType], [TransactionDate], [Quantity], [ActualCost])\n                       SELECT\n                           inserted.[ProductID],\n                           inserted.[SalesOrderID],\n                           inserted.[SalesOrderDetailID],\n                           'S',\n                           GETDATE(),\n                           inserted.[OrderQty],\n                           inserted.[UnitPrice]\n                       FROM  \n                           inserted INNER JOIN\n                           [Sales].[SalesOrderHeader] ON\n                                inserted.[SalesOrderID] = [Sales].[SalesOrderHeader].[SalesOrderID];\n                       UPDATE [Person].[Person]\n                       SET    [Demographics].modify('declare default element namespace \n                \u0022http://schemas.microsoft.com/sqlserver/2004/07/adventure-works/IndividualSurvey\u0022; \n                replace value of (/IndividualSurvey/TotalPurchaseYTD)[1] \n                with data(/IndividualSurvey/TotalPurchaseYTD)[1] + sql:column (\u0022inserted.LineTotal\u0022)')\n                       FROM  \n                           inserted INNER JOIN\n                           [Sales].[SalesOrderHeader] AS SOH ON\n                                inserted.[SalesOrderID] = SOH.[SalesOrderID] INNER JOIN\n                           [Sales].[Customer] AS C ON\n                                SOH.[CustomerID] = C.[CustomerID] WHERE\n                                                                       C.[PersonID] = [Person].[Person].[BusinessEntityID];\n                   END\n               UPDATE [Sales].[SalesOrderHeader]\n               SET    [Sales].[SalesOrderHeader].[SubTotal] = (SELECT\n                                                                   SUM([Sales].[SalesOrderDetail].[LineTotal])\n                                                               FROM  \n                                                                   [Sales].[SalesOrderDetail] WHERE\n                                                                                                   [Sales].[SalesOrderHeader].[SalesOrderID] = [Sales].[SalesOrderDetail].[SalesOrderID]) WHERE\n                                                                                                                                                                                               [Sales].[SalesOrderHeader].[SalesOrderID] IN (SELECT\n                                                                                                                                                                                                                                                 inserted.[SalesOrderID]\n                                                                                                                                                                                                                                             FROM  \n                                                                                                                                                                                                                                                 inserted);\n               UPDATE [Person].[Person]\n               SET    [Demographics].modify('declare default element namespace \n            \u0022http://schemas.microsoft.com/sqlserver/2004/07/adventure-works/IndividualSurvey\u0022; \n            replace value of (/IndividualSurvey/TotalPurchaseYTD)[1] \n            with data(/IndividualSurvey/TotalPurchaseYTD)[1] - sql:column(\u0022deleted.LineTotal\u0022)')\n               FROM  \n                   deleted INNER JOIN\n                   [Sales].[SalesOrderHeader] ON\n                        deleted.[SalesOrderID] = [Sales].[SalesOrderHeader].[SalesOrderID] INNER JOIN\n                   [Sales].[Customer] ON\n                        [Sales].[Customer].[CustomerID] = [Sales].[SalesOrderHeader].[CustomerID] WHERE\n                                                                                                       [Sales].[Customer].[PersonID] = [Person].[Person].[BusinessEntityID];\n           END TRY\n           BEGIN CATCH\n               EXECUTE [dbo].[uspPrintError] ;\n               IF @@TRANCOUNT > 0\n                   BEGIN\n                       ROLLBACK;\n                   END\n               EXECUTE [dbo].[uspLogError] ;\n           END CATCH\n       END",
  "tableName": "SalesOrderDetail"
}