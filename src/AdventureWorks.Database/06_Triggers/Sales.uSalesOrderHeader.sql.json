{
  "triggerName": "uSalesOrderHeader",
  "schemaName": "Sales",
  "definition": "CREATE TRIGGER [Sales].[uSalesOrderHeader]\n    ON [Sales].[SalesOrderHeader]\n    AFTER UPDATE\n    NOT FOR REPLICATION\n    AS BEGIN\n           DECLARE @Count AS INT;\n           SET @Count = @@ROWCOUNT;\n           IF @Count = 0\n               RETURN;\n           SET NOCOUNT ON;\n           BEGIN TRY\n               IF NOT UPDATE ([Status])\n                   BEGIN\n                       UPDATE [Sales].[SalesOrderHeader]\n                       SET    [Sales].[SalesOrderHeader].[RevisionNumber] = [Sales].[SalesOrderHeader].[RevisionNumber] + 1 WHERE\n                                                                                                                                 [Sales].[SalesOrderHeader].[SalesOrderID] IN (SELECT\n                                                                                                                                                                                   inserted.[SalesOrderID]\n                                                                                                                                                                               FROM  \n                                                                                                                                                                                   inserted);\n                   END\n               IF UPDATE ([SubTotal])\n                   BEGIN\n                       DECLARE @StartDate AS DATETIME, @EndDate AS DATETIME;\n                       SET @StartDate = [dbo].[ufnGetAccountingStartDate]();\n                       SET @EndDate = [dbo].[ufnGetAccountingEndDate]();\n                       UPDATE [Sales].[SalesPerson]\n                       SET    [Sales].[SalesPerson].[SalesYTD] = (SELECT\n                                                                      SUM([Sales].[SalesOrderHeader].[SubTotal])\n                                                                  FROM  \n                                                                      [Sales].[SalesOrderHeader] WHERE\n                                                                                                      [Sales].[SalesPerson].[BusinessEntityID] = [Sales].[SalesOrderHeader].[SalesPersonID] AND ([Sales].[SalesOrderHeader].[Status] = 5) AND [Sales].[SalesOrderHeader].[OrderDate] BETWEEN @StartDate AND @EndDate) WHERE\n                                                                                                                                                                                                                                                                                                                           [Sales].[SalesPerson].[BusinessEntityID] IN (SELECT DISTINCT\n                                                                                                                                                                                                                                                                                                                                                                            inserted.[SalesPersonID]\n                                                                                                                                                                                                                                                                                                                                                                        FROM  \n                                                                                                                                                                                                                                                                                                                                                                            inserted WHERE\n                                                                                                                                                                                                                                                                                                                                                                                          inserted.[OrderDate] BETWEEN @StartDate AND @EndDate);\n                       UPDATE [Sales].[SalesTerritory]\n                       SET    [Sales].[SalesTerritory].[SalesYTD] = (SELECT\n                                                                         SUM([Sales].[SalesOrderHeader].[SubTotal])\n                                                                     FROM  \n                                                                         [Sales].[SalesOrderHeader] WHERE\n                                                                                                         [Sales].[SalesTerritory].[TerritoryID] = [Sales].[SalesOrderHeader].[TerritoryID] AND ([Sales].[SalesOrderHeader].[Status] = 5) AND [Sales].[SalesOrderHeader].[OrderDate] BETWEEN @StartDate AND @EndDate) WHERE\n                                                                                                                                                                                                                                                                                                                          [Sales].[SalesTerritory].[TerritoryID] IN (SELECT DISTINCT\n                                                                                                                                                                                                                                                                                                                                                                         inserted.[TerritoryID]\n                                                                                                                                                                                                                                                                                                                                                                     FROM  \n                                                                                                                                                                                                                                                                                                                                                                         inserted WHERE\n                                                                                                                                                                                                                                                                                                                                                                                       inserted.[OrderDate] BETWEEN @StartDate AND @EndDate);\n                   END\n           END TRY\n           BEGIN CATCH\n               EXECUTE [dbo].[uspPrintError] ;\n               IF @@TRANCOUNT > 0\n                   BEGIN\n                       ROLLBACK;\n                   END\n               EXECUTE [dbo].[uspLogError] ;\n           END CATCH\n       END",
  "tableName": "SalesOrderHeader"
}