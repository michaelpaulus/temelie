{
  "triggerName": "uSalesOrderHeader",
  "schemaName": "Sales",
  "definition": "CREATE TRIGGER [Sales].[uSalesOrderHeader] ON [Sales].[SalesOrderHeader] \nAFTER UPDATE NOT FOR REPLICATION AS \nBEGIN\n    DECLARE @Count int;\n\n    SET @Count = @@ROWCOUNT;\n    IF @Count = 0 \n        RETURN;\n\n    SET NOCOUNT ON;\n\n    BEGIN TRY\n        -- Update RevisionNumber for modification of any field EXCEPT the Status.\n        IF NOT UPDATE([Status])\n        BEGIN\n            UPDATE [Sales].[SalesOrderHeader]\n            SET [Sales].[SalesOrderHeader].[RevisionNumber] = \n                [Sales].[SalesOrderHeader].[RevisionNumber] + 1\n            WHERE [Sales].[SalesOrderHeader].[SalesOrderID] IN \n                (SELECT inserted.[SalesOrderID] FROM inserted);\n        END;\n\n        -- Update the SalesPerson SalesYTD when SubTotal is updated\n        IF UPDATE([SubTotal])\n        BEGIN\n            DECLARE @StartDate datetime,\n                    @EndDate datetime\n\n            SET @StartDate = [dbo].[ufnGetAccountingStartDate]();\n            SET @EndDate = [dbo].[ufnGetAccountingEndDate]();\n\n            UPDATE [Sales].[SalesPerson]\n            SET [Sales].[SalesPerson].[SalesYTD] = \n                (SELECT SUM([Sales].[SalesOrderHeader].[SubTotal])\n                FROM [Sales].[SalesOrderHeader] \n                WHERE [Sales].[SalesPerson].[BusinessEntityID] = [Sales].[SalesOrderHeader].[SalesPersonID]\n                    AND ([Sales].[SalesOrderHeader].[Status] = 5) -- Shipped\n                    AND [Sales].[SalesOrderHeader].[OrderDate] BETWEEN @StartDate AND @EndDate)\n            WHERE [Sales].[SalesPerson].[BusinessEntityID] \n                IN (SELECT DISTINCT inserted.[SalesPersonID] FROM inserted \n                    WHERE inserted.[OrderDate] BETWEEN @StartDate AND @EndDate);\n\n            -- Update the SalesTerritory SalesYTD when SubTotal is updated\n            UPDATE [Sales].[SalesTerritory]\n            SET [Sales].[SalesTerritory].[SalesYTD] = \n                (SELECT SUM([Sales].[SalesOrderHeader].[SubTotal])\n                FROM [Sales].[SalesOrderHeader] \n                WHERE [Sales].[SalesTerritory].[TerritoryID] = [Sales].[SalesOrderHeader].[TerritoryID]\n                    AND ([Sales].[SalesOrderHeader].[Status] = 5) -- Shipped\n                    AND [Sales].[SalesOrderHeader].[OrderDate] BETWEEN @StartDate AND @EndDate)\n            WHERE [Sales].[SalesTerritory].[TerritoryID] \n                IN (SELECT DISTINCT inserted.[TerritoryID] FROM inserted \n                    WHERE inserted.[OrderDate] BETWEEN @StartDate AND @EndDate);\n        END;\n    END TRY\n    BEGIN CATCH\n        EXECUTE [dbo].[uspPrintError];\n\n        -- Rollback any active or uncommittable transactions before\n        -- inserting information in the ErrorLog\n        IF @@TRANCOUNT > 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n        END\n\n        EXECUTE [dbo].[uspLogError];\n    END CATCH;\nEND;",
  "tableName": "SalesOrderHeader"
}