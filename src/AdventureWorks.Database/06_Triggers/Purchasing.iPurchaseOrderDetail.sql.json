{
  "triggerName": "iPurchaseOrderDetail",
  "schemaName": "Purchasing",
  "definition": "CREATE TRIGGER [Purchasing].[iPurchaseOrderDetail] ON [Purchasing].[PurchaseOrderDetail] \nAFTER INSERT AS\nBEGIN\n    DECLARE @Count int;\n\n    SET @Count = @@ROWCOUNT;\n    IF @Count = 0 \n        RETURN;\n\n    SET NOCOUNT ON;\n\n    BEGIN TRY\n        INSERT INTO [Production].[TransactionHistory]\n            ([ProductID]\n            ,[ReferenceOrderID]\n            ,[ReferenceOrderLineID]\n            ,[TransactionType]\n            ,[TransactionDate]\n            ,[Quantity]\n            ,[ActualCost])\n        SELECT \n            inserted.[ProductID]\n            ,inserted.[PurchaseOrderID]\n            ,inserted.[PurchaseOrderDetailID]\n            ,'P'\n            ,GETDATE()\n            ,inserted.[OrderQty]\n            ,inserted.[UnitPrice]\n        FROM inserted \n            INNER JOIN [Purchasing].[PurchaseOrderHeader] \n            ON inserted.[PurchaseOrderID] = [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID];\n\n        -- Update SubTotal in PurchaseOrderHeader record. Note that this causes the \n        -- PurchaseOrderHeader trigger to fire which will update the RevisionNumber.\n        UPDATE [Purchasing].[PurchaseOrderHeader]\n        SET [Purchasing].[PurchaseOrderHeader].[SubTotal] = \n            (SELECT SUM([Purchasing].[PurchaseOrderDetail].[LineTotal])\n                FROM [Purchasing].[PurchaseOrderDetail]\n                WHERE [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID])\n        WHERE [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID] IN (SELECT inserted.[PurchaseOrderID] FROM inserted);\n    END TRY\n    BEGIN CATCH\n        EXECUTE [dbo].[uspPrintError];\n\n        -- Rollback any active or uncommittable transactions before\n        -- inserting information in the ErrorLog\n        IF @@TRANCOUNT > 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n        END\n\n        EXECUTE [dbo].[uspLogError];\n    END CATCH;\nEND;",
  "tableName": "PurchaseOrderDetail"
}