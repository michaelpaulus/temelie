{
  "triggerName": "uPurchaseOrderDetail",
  "schemaName": "Purchasing",
  "definition": "CREATE TRIGGER [Purchasing].[uPurchaseOrderDetail] ON [Purchasing].[PurchaseOrderDetail] \nAFTER UPDATE AS \nBEGIN\n    DECLARE @Count int;\n\n    SET @Count = @@ROWCOUNT;\n    IF @Count = 0 \n        RETURN;\n\n    SET NOCOUNT ON;\n\n    BEGIN TRY\n        IF UPDATE([ProductID]) OR UPDATE([OrderQty]) OR UPDATE([UnitPrice])\n        -- Insert record into TransactionHistory \n        BEGIN\n            INSERT INTO [Production].[TransactionHistory]\n                ([ProductID]\n                ,[ReferenceOrderID]\n                ,[ReferenceOrderLineID]\n                ,[TransactionType]\n                ,[TransactionDate]\n                ,[Quantity]\n                ,[ActualCost])\n            SELECT \n                inserted.[ProductID]\n                ,inserted.[PurchaseOrderID]\n                ,inserted.[PurchaseOrderDetailID]\n                ,'P'\n                ,GETDATE()\n                ,inserted.[OrderQty]\n                ,inserted.[UnitPrice]\n            FROM inserted \n                INNER JOIN [Purchasing].[PurchaseOrderDetail] \n                ON inserted.[PurchaseOrderID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID];\n\n            -- Update SubTotal in PurchaseOrderHeader record. Note that this causes the \n            -- PurchaseOrderHeader trigger to fire which will update the RevisionNumber.\n            UPDATE [Purchasing].[PurchaseOrderHeader]\n            SET [Purchasing].[PurchaseOrderHeader].[SubTotal] = \n                (SELECT SUM([Purchasing].[PurchaseOrderDetail].[LineTotal])\n                    FROM [Purchasing].[PurchaseOrderDetail]\n                    WHERE [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID] \n                        = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID])\n            WHERE [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID] \n                IN (SELECT inserted.[PurchaseOrderID] FROM inserted);\n\n            UPDATE [Purchasing].[PurchaseOrderDetail]\n            SET [Purchasing].[PurchaseOrderDetail].[ModifiedDate] = GETDATE()\n            FROM inserted\n            WHERE inserted.[PurchaseOrderID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID]\n                AND inserted.[PurchaseOrderDetailID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderDetailID];\n        END;\n    END TRY\n    BEGIN CATCH\n        EXECUTE [dbo].[uspPrintError];\n\n        -- Rollback any active or uncommittable transactions before\n        -- inserting information in the ErrorLog\n        IF @@TRANCOUNT > 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n        END\n\n        EXECUTE [dbo].[uspLogError];\n    END CATCH;\nEND;",
  "tableName": "PurchaseOrderDetail"
}