{
  "definitionName": "uspGetEmployeeManagers",
  "schemaName": "dbo",
  "definition": "CREATE PROCEDURE [dbo].[uspGetEmployeeManagers]\n    @BusinessEntityID [int]\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    -- Use recursive query to list out all Employees required for a particular Manager\n    WITH [EMP_cte]([BusinessEntityID], [OrganizationNode], [FirstName], [LastName], [JobTitle], [RecursionLevel]) -- CTE name and columns\n    AS (\n        SELECT e.[BusinessEntityID], e.[OrganizationNode], p.[FirstName], p.[LastName], e.[JobTitle], 0 -- Get the initial Employee\n        FROM [HumanResources].[Employee] e \n            INNER JOIN [Person].[Person] as p\n            ON p.[BusinessEntityID] = e.[BusinessEntityID]\n        WHERE e.[BusinessEntityID] = @BusinessEntityID\n        UNION ALL\n        SELECT e.[BusinessEntityID], e.[OrganizationNode], p.[FirstName], p.[LastName], e.[JobTitle], [RecursionLevel] + 1 -- Join recursive member to anchor\n        FROM [HumanResources].[Employee] e \n            INNER JOIN [EMP_cte]\n            ON e.[OrganizationNode] = [EMP_cte].[OrganizationNode].GetAncestor(1)\n            INNER JOIN [Person].[Person] p \n            ON p.[BusinessEntityID] = e.[BusinessEntityID]\n    )\n    -- Join back to Employee to return the manager name \n    SELECT [EMP_cte].[RecursionLevel], [EMP_cte].[BusinessEntityID], [EMP_cte].[FirstName], [EMP_cte].[LastName], \n        [EMP_cte].[OrganizationNode].ToString() AS [OrganizationNode], p.[FirstName] AS 'ManagerFirstName', p.[LastName] AS 'ManagerLastName'  -- Outer select from the CTE\n    FROM [EMP_cte] \n        INNER JOIN [HumanResources].[Employee] e \n        ON [EMP_cte].[OrganizationNode].GetAncestor(1) = e.[OrganizationNode]\n        INNER JOIN [Person].[Person] p \n        ON p.[BusinessEntityID] = e.[BusinessEntityID]\n    ORDER BY [RecursionLevel], [EMP_cte].[OrganizationNode].ToString()\n    OPTION (MAXRECURSION 25) \nEND;",
  "xType": "P",
  "type": "PROCEDURE"
}